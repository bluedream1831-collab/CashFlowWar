<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾é‡‘æµæˆ°è¨˜ï¼šä¸Šç­æ—çš„é€†è¥²</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --text-color: #ecf0f1;
            --accent-color: #e67e22;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --blog-color: #20bf6b; /* éƒ¨è½æ ¼æŒ‰éˆ•è‰² */
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .header {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .level-badge {
            background: var(--accent-color);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        /* å„€è¡¨æ¿å€åŸŸ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        @media (min-width: 600px) {
            .dashboard { grid-template-columns: repeat(4, 1fr); }
        }

        .stat-card {
            background: var(--panel-bg);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--accent-color);
        }

        .stat-label { font-size: 0.9em; color: #bdc3c7; }
        .stat-value { font-size: 1.3em; font-weight: bold; margin-top: 5px; }

        .sanity-bar-container {
            width: 100%;
            background: #2c3e50;
            height: 8px;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .sanity-bar {
            height: 100%;
            background: var(--success-color);
            width: 100%;
            transition: width 0.3s, background 0.3s;
        }

        /* ä¸»ç•«é¢èˆ‡åŠ‡æƒ…å€ */
        .main-stage {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 10px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            transition: background 0.5s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* èƒŒæ™¯åœ–è¨­å®š */
        .bg-level1 { background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1542744173-8e7e53415bb0?auto=format&fit=crop&w=800&q=80'); } 
        .bg-level2 { background-image: linear-gradient(rgba(0,0,0,0.75), rgba(0,0,0,0.75)), url('https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&w=800&q=80'); } 
        .bg-level3 { background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&w=800&q=80'); } 
        .bg-level4 { background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=80'); } 

        /* NPC å°è©±å€ */
        .dialogue-box { margin-bottom: 20px; }
        .npc-tag {
            display: inline-flex; align-items: center;
            background: rgba(0,0,0,0.6); padding: 5px 10px;
            border-radius: 20px; margin-bottom: 10px;
            font-size: 0.9em; color: #f1c40f; border: 1px solid #f1c40f;
        }
        .story-text { font-size: 1.2em; line-height: 1.6; min-height: 60px; text-shadow: 1px 1px 2px black; }

        /* æŠ•è³‡é¢æ¿ */
        .investment-panel {
            background: rgba(44, 62, 80, 0.95); padding: 15px; border-radius: 8px;
            margin-bottom: 15px; border: 1px solid #7f8c8d; animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stock-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stock-name { font-weight: bold; color: var(--warning-color); }
        .stock-price { font-family: monospace; font-size: 1.1em; }

        /* æŒ‰éˆ•å€ */
        .actions { display: grid; gap: 10px; }
        button {
            background: var(--accent-color); border: none; color: white;
            padding: 15px; border-radius: 8px; font-size: 1em;
            cursor: pointer; transition: all 0.2s; text-align: left;
            position: relative; overflow: hidden;
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.btn-choice span { display: block; font-size: 0.8em; opacity: 0.8; margin-top: 3px; }
        .btn-invest { background: #2980b9; text-align: center; padding: 10px; }
        .btn-next { background: #7f8c8d; text-align: center; }

        /* æç¤ºèˆ‡å°æµå€å¡Š (New) */
        .guide-section {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            border: 1px dashed #7f8c8d;
        }
        .guide-title { color: var(--warning-color); font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .tips-list { list-style: none; padding: 0; margin: 0; font-size: 0.95em; color: #bdc3c7; }
        .tips-list li { margin-bottom: 8px; padding-left: 20px; position: relative; }
        .tips-list li::before { content: "ğŸ‘‰"; position: absolute; left: 0; }
        .highlight { color: var(--success-color); font-weight: bold; }

        /* éƒ¨è½æ ¼æŒ‰éˆ• (New) */
        .blog-link {
            display: block;
            background: var(--blog-color);
            color: white;
            text-decoration: none;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            transition: transform 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .blog-link:hover { transform: scale(1.02); filter: brightness(1.1); }

        /* çµå±€èˆ‡å½ˆçª— */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--panel-bg); padding: 30px; border-radius: 10px;
            text-align: center; max-width: 500px; border: 2px solid var(--accent-color);
        }
        .ending-badge { font-size: 3em; margin-bottom: 10px; }

        /* Toast æç¤º */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px;
            opacity: 0; transition: opacity 0.5s; pointer-events: none; border: 1px solid var(--accent-color);
        }

    </style>
</head>
<body>

<div class="container">
    <!-- é ‚éƒ¨ -->
    <div class="header">
        <div><span id="game-date">ç¬¬ 1 å¹´ 1 æœˆ</span></div>
        <div class="level-badge" id="level-display">ç¬¬ä¸€ç« ï¼šç”Ÿå­˜çš„ç¸«éš™</div>
    </div>

    <!-- å„€è¡¨æ¿ -->
    <div class="dashboard">
        <div class="stat-card" style="border-color: #f1c40f;">
            <div class="stat-label">ğŸ’° æ‰‹ä¸Šç¾é‡‘</div>
            <div class="stat-value" id="cash-display">$50,000</div>
        </div>
        <div class="stat-card" style="border-color: #3498db;">
            <div class="stat-label">ğŸ“ˆ è‚¡ç¥¨å¸‚å€¼</div>
            <div class="stat-value" id="asset-display">$0</div>
        </div>
        <div class="stat-card" style="border-color: #e74c3c;">
            <div class="stat-label">ğŸ§  ç²¾ç¥å€¼</div>
            <div class="sanity-bar-container">
                <div class="sanity-bar" id="sanity-bar"></div>
            </div>
            <div class="stat-label" style="margin-top: 5px;" id="sanity-text">80/100</div>
        </div>
        <div class="stat-card" style="border-color: #9b59b6;">
            <div class="stat-label">ğŸ’¸ æœˆç¾é‡‘æµ</div>
            <div class="stat-value" id="flow-display">+$0</div>
        </div>
    </div>

    <!-- ä¸»èˆå° -->
    <div class="main-stage bg-level1" id="main-bg">
        
        <!-- ä¸ŠåŠéƒ¨ï¼šåŠ‡æƒ…èˆ‡NPC -->
        <div>
            <div class="dialogue-box">
                <div class="npc-tag" id="npc-tag">ğŸ‘¨â€ğŸ’¼ ä¸»è§’å…§å¿ƒ</div>
                <div class="story-text" id="story-text">
                    æ•…äº‹è¼‰å…¥ä¸­...
                </div>
            </div>

            <!-- æŠ•è³‡é¢æ¿ (Level 2+ å‡ºç¾) -->
            <div class="investment-panel" id="invest-panel" style="display: none;">
                <div class="stock-row">
                    <div>
                        <div class="stock-name">00878 é«˜è‚¡æ¯</div>
                        <div style="font-size: 0.8em; color: #bdc3c7;">æŒæœ‰: <span id="qty-878">0</span> å¼µ</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="stock-price" id="price-878">$15.00</div>
                        <div style="font-size: 0.8em;">é…æ¯ç©©å®š</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-invest" onclick="game.trade('00878', 1)">è²·å…¥ (-$<span id="cost-878">15000</span>)</button>
                    <button class="btn-invest" style="background: #c0392b;" onclick="game.trade('00878', -1)">è³£å‡º</button>
                </div>
            </div>
        </div>

        <!-- ä¸‹åŠéƒ¨ï¼šé¸æ“‡æŒ‰éˆ• -->
        <div class="actions" id="action-area">
            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æ–°å¢ï¼šç”Ÿå­˜æŒ‡å—èˆ‡å°æµ -->
    <div class="guide-section">
        <div class="guide-title">ğŸ’¡ ç©å®¶ç”Ÿå­˜æŒ‡å— (Game Tips)</div>
        <ul class="tips-list">
            <li><b>ç²¾ç¥å€¼æ˜¯é—œéµï¼š</b>ä¸è¦ç•¶è‹¦è¡Œåƒ§ï¼è‹¥<span class="highlight">ç²¾ç¥ < 30</span> æœƒè§¸ç™¼ã€Œå ±å¾©æ€§æ¶ˆè²»ã€è®“ä½ ç ´ç”¢ã€‚é©æ™‚èŠ±å°éŒ¢å–é£²æ–™ï¼Œæ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ã€‚</li>
            <li><b>ç¬¬ä¸€æ¡¶é‡‘å¾ˆé‡è¦ï¼š</b>Level 1 è«‹å„ªå…ˆå­˜åˆ° 10 è¬ã€Œç·Šæ€¥é å‚™é‡‘ã€ï¼Œä¸è¦æ€¥è‘—è²·è‚¡ç¥¨ï¼Œå¦å‰‡é‡åˆ°ä¿®è»Š/ç”Ÿç—…æœƒè¢«è¿«æ®ºä½è³£å‡ºã€‚</li>
            <li><b>è¤‡åˆ©çš„åŠ›é‡ï¼š</b>åˆæœŸè‚¡æ¯å¾ˆå°‘æ˜¯æ­£å¸¸çš„ã€‚å …æŒåˆ° Level 3ï¼Œä½ æœƒç™¼ç¾è‚¡æ¯å¢åŠ çš„é€Ÿåº¦æ¯”åŠ è–ªé‚„å¿«ã€‚</li>
            <li><b>æƒ³å­¸çœŸçš„ç†è²¡ï¼Ÿ</b>éŠæˆ²æ˜¯ç°¡åŒ–çš„ï¼ŒçœŸå¯¦ä¸–ç•Œè«‹çœ‹ä¸‹æ–¹çš„ç†è²¡ç­†è¨˜ ğŸ‘‡</li>
        </ul>
    </div>

    <a href="https://vocus.cc/user/@WUCJ" target="_blank" class="blog-link">
        ğŸ“– å–œæ­¡é€™æ¬¾éŠæˆ²ï¼Ÿä¾†é€›é€›æˆ‘çš„éƒ¨è½æ ¼ã€WUCJ çš„ç†è²¡ç­†è¨˜ã€‘
    </a>

</div>

<div class="toast" id="toast">è¨Šæ¯</div>

<!-- çµå±€/åŠ‡æƒ…å½ˆçª— -->
<div class="modal" id="modal">
    <div class="modal-content">
        <div class="ending-badge" id="modal-icon">ğŸ“œ</div>
        <h2 id="modal-title">ç« ç¯€å®Œæˆ</h2>
        <p id="modal-desc" style="white-space: pre-line; line-height: 1.6;">å…§å®¹</p>
        
        <!-- çµå±€æ™‚é¡¯ç¤ºçš„é¡å¤–æŒ‰éˆ• -->
        <div id="modal-blog-btn" style="display:none; margin-top: 15px;">
            <a href="https://vocus.cc/user/@WUCJ" target="_blank" class="blog-link" style="background: #e67e22; font-size: 0.9em;">
                ğŸ‘‰ é»æ“Šé–±è®€ï¼šå¦‚ä½•åƒä¸»è§’ä¸€æ¨£ç¿»èº«ï¼Ÿ
            </a>
        </div>

        <button onclick="game.closeModal()" id="modal-action-btn" style="margin-top: 20px; width: 100%; text-align: center;">ç¹¼çºŒ</button>
    </div>
</div>

<script>
    // --- éŠæˆ²è¨­å®š ---
    const CONFIG = {
        salary: 38000,
        baseExpense: 28000, 
        inflation: 0.002,   
        yield: 0.015        
    };

    // --- åŠ‡æƒ…èˆ‡äº‹ä»¶åº« ---
    const LEVEL_EVENTS = {
        1: [ // Survival
            {
                npc: "â˜• éš”å£åŒäº‹",
                text: "ã€Œæ¬¸ï¼ä»Šå¤©æ˜ŸæœŸäº”ï¼Œè¦ä¸è¦è¨‚é‚£å®¶è¶…è²´çš„æ˜Ÿå†°æ¨‚ï¼Ÿä¸€æ¯ 150 å–”ï¼ä¸å–æ²’è©±é¡Œå•¦ï½ã€",
                choices: [
                    { text: "å–å•¦ï¼ä¸Šç­é‚£éº¼è‹¦", sub: "é‡‘éŒ¢ -$150 / ç²¾ç¥ +10", cost: 150, sanity: 10 },
                    { text: "ä¸äº†ï¼Œæˆ‘å–å…¬å¸é£²æ°´æ©Ÿ", sub: "é‡‘éŒ¢ -$0 / ç²¾ç¥ -5 (ç•¥é¡¯å­¤åƒ»)", cost: 0, sanity: -5 }
                ]
            },
            {
                npc: "ğŸ“± è³¼ç‰©å»£å‘Š",
                text: "æ»‘æ‰‹æ©Ÿæ™‚è·³å‡ºå»£å‘Šï¼šã€æ–°æ¬¾ iPhone ç¾è²¨ä¾›æ‡‰ã€ï¼Œä½ æ‰‹ä¸Šçš„èˆŠæ©Ÿå‰›å¥½ç•¶æ©Ÿäº†...",
                choices: [
                    { text: "åˆ†æœŸä»˜æ¬¾è²·ä¸‹å»ï¼", sub: "é‡‘éŒ¢ -$30,000 / ç²¾ç¥ +40", cost: 30000, sanity: 40 },
                    { text: "é‡é–‹æ©Ÿç¹¼çºŒç”¨ï¼Œé‚„èƒ½æˆ°", sub: "é‡‘éŒ¢ -$0 / ç²¾ç¥ -5", cost: 0, sanity: -5 }
                ]
            },
            {
                npc: "ğŸ‘¨â€ğŸ’¼ ä¸»è§’å…§å¿ƒ",
                text: "ç™¼è–ªæ—¥å‰›éï¼Œç¹³å®Œæˆ¿ç§Ÿã€å¡è²»ï¼Œçœ‹è‘—ç¶²éŠ€çš„é¤˜é¡ï¼Œçªç„¶è¦ºå¾—é€™ä»½å·¥ä½œå¥½ç©ºè™›ã€‚",
                choices: [
                    { text: "åƒé “å¥½çš„å®‰æ…°è‡ªå·±", sub: "é‡‘éŒ¢ -$500 / ç²¾ç¥ +5", cost: 500, sanity: 5 },
                    { text: "å¿è€ï¼Œå›å®¶åƒæ³¡éºµ", sub: "é‡‘éŒ¢ -$50 / ç²¾ç¥ -5", cost: 50, sanity: -5 }
                ]
            }
        ],
        2: [ // First Seed
            {
                npc: "ğŸ“‰ è²¡ç¶“æ–°è",
                text: "ã€å¤–è³‡å¤§é€ƒæ®ºï¼å°è‚¡é‡æŒ« 300 é»ï¼ã€ä½ çœ‹è‘—å‰›è²·çš„ ETF å¸³é¢è®Šç¶ è‰²...",
                choices: [
                    { text: "åš‡æ­»äº†ï¼Œè¶•å¿«è³£æ‰æ­¢æï¼", sub: "å¯¦ç¾è™§æ / ç²¾ç¥ -20", action: 'panic_sell' },
                    { text: "é—œæ‰ APPï¼Œå°ˆæ³¨æœ¬æ¥­", sub: "ç²¾ç¥ +5 / è¶Šè·Œè¶Šè²·", action: 'hold' }
                ]
            },
            {
                npc: "ğŸï¸ æ©Ÿè»Šè¡Œè€é—†",
                text: "ã€Œå°‘å¹´ä»”ï¼Œä½ é€™å°é€šå‹¤è»Šçš®å¸¶æ–·äº†ï¼Œæ™®åˆ©ç ä¹Ÿè¦æ›ï¼Œä¿®åˆ°å¥½è¦ 3,000 å–”ã€‚ã€",
                choices: [
                    { text: "ä¿®... (å‹•ç”¨ç·Šæ€¥é å‚™é‡‘)", sub: "é‡‘éŒ¢ -$3,000 / ç²¾ç¥ -10", cost: 3000, sanity: -10 }
                ]
            },
            {
                npc: "ğŸ•µï¸ ç¥ç§˜ç†è²¡å®¢",
                text: "ã€Œä½ çœ‹é‚£æª” 00878ï¼Œé›–ç„¶ç¾åœ¨è·Œï¼Œä½†å®ƒçš„å¡«æ¯ç´€éŒ„å¾ˆå¥½ã€‚é€™æ˜¯ç´¯ç©å¼µæ•¸çš„å¥½æ©Ÿæœƒã€‚ã€",
                choices: [
                    { text: "è½ä½ çš„ï¼ŒåŠ ç¢¼ä¸€å¼µï¼", sub: "é‡‘éŒ¢ -ç›®å‰è‚¡åƒ¹ / ç²¾ç¥ +10", action: 'buy_one' },
                    { text: "é‚„æ˜¯å†è§€æœ›ä¸€ä¸‹...", sub: "ç„¡è®Šå‹•", cost: 0, sanity: 0 }
                ]
            }
        ],
        3: [ // Compounding
            {
                npc: "ğŸ‘¨â€ğŸ’¼ ä¸»è§’å…§å¿ƒ",
                text: "å…­é»äº†ï¼Œè€é—†é‚„æ²’èµ°ã€‚ç¾åœ¨ä¸‹ç­æœƒä¸æœƒè¢«è²¼æ¨™ç±¤ï¼Ÿä½†å›å®¶æƒ³ç ”ç©¶è²¡å ±...",
                choices: [
                    { text: "è£å¿™åŠ ç­ï¼Œæ¼”çµ¦è€é—†çœ‹", sub: "æ”¶å…¥ä¸è®Š / ç²¾ç¥ -10", cost: 0, sanity: -10 },
                    { text: "æº–æ™‚ä¸‹ç­ï¼ŒæŠ•è³‡è‡ªå·±", sub: "çŸ¥è­˜ +1 / ç²¾ç¥ +5", action: 'study' }
                ]
            },
            {
                npc: "ğŸš— å¤§å­¸åŒå­¸",
                text: "ã€Œæ¬¸æˆ‘è²·æ–°è»Šäº†ï¼Œç‰¹æ–¯æ‹‰å–”ï¼ä½ é‚„åœ¨é¨é‚£å°èˆŠæ©Ÿè»Šé€šå‹¤å–”ï¼Ÿä¸ç†±å—ï¼Ÿã€",
                choices: [
                    { text: "æˆ‘ä¹Ÿè¦è²·è»Šï¼(è¢«æ¿€æ€’)", sub: "é ­æœŸæ¬¾ -$50,000 / ç²¾ç¥ +30", cost: 50000, sanity: 30 },
                    { text: "ç¬‘ç¬‘å¸¶é (é‚£æ˜¯è² å‚µ)", sub: "ç²¾ç¥ -5 / å®ˆä½è²¡å¯Œ", cost: 0, sanity: -5 }
                ]
            }
        ],
        4: [ // Freedom
             {
                npc: "ğŸ•µï¸ ç¥ç§˜ç†è²¡å®¢",
                text: "ã€Œä½ çš„è³‡ç”¢è¦æ¨¡å·²ç¶“ä¸ä¸€æ¨£äº†ã€‚åªè¦å …æŒä¸‹å»ï¼Œé»æ˜å°±åœ¨çœ¼å‰ã€‚ã€",
                choices: [
                    { text: "å …æŒè‚¡æ¯å†æŠ•å…¥", sub: "åŠ é€Ÿè¤‡åˆ©", sanity: 5, cost: 0 }
                ]
             }
        ]
    };

    // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
    class Game {
        constructor() {
            this.state = {
                month: 0,
                cash: 50000,
                sanity: 80,
                level: 1,
                expense: CONFIG.baseExpense,
                shares: 0, 
                stockPrice: 15.00,
                knowledge: 0,
                history: []
            };
            this.init();
        }

        init() {
            this.showModal("ğŸ“– åºç« ï¼šè¢«å›°ä½çš„æ»¾è¼ª", 
                "ä½ æ˜¯ä¸€å 30 æ­²çš„å¹³å‡¡ä¸Šç­æ—ã€‚\n\næ¯å¤©é¢å°åšä¸å®Œçš„å ±è¡¨ã€å›ä¸å®Œçš„ Emailã€‚\nè–ªæ°´ 38,000 å…ƒï¼Œæ‰£æ‰æˆ¿ç§Ÿç”Ÿæ´»è²»ï¼Œæ¯å€‹æœˆå¹¾ä¹å­˜ä¸åˆ°éŒ¢ã€‚\n\nä½ çœ‹ä¼¼å®‰ç©©ï¼Œå…¶å¯¦æ­£è™•æ–¼å±éšªé‚Šç·£ã€‚\nä½ çš„ç›®æ¨™ï¼šåœ¨ 60 æ­²å‰ï¼Œç”¨é€™ä»½æ­»è–ªæ°´ï¼Œæ‰“é€ å‡ºèƒ½é¤Šæ´»ä½ çš„ã€Œç¾é‡‘æµè­·ç›¾ã€ã€‚");
            this.updateUI();
            this.nextMonth();
        }

        nextMonth() {
            this.state.month++;
            
            // 1. è²¡å‹™è¨ˆç®—
            this.state.expense *= (1 + CONFIG.inflation);
            const monthlySave = CONFIG.salary - Math.floor(this.state.expense);
            this.state.cash += monthlySave;
            this.state.sanity -= 3; 

            // 2. è‚¡å¸‚æ³¢å‹•
            const change = (Math.random() * 0.1) - 0.04; 
            this.state.stockPrice *= (1 + change);
            if(this.state.stockPrice < 10) this.state.stockPrice = 10;

            // 3. é…æ¯
            let dividend = 0;
            if ((this.state.month) % 3 === 0 && this.state.shares > 0) {
                dividend = Math.floor(this.state.shares * this.state.stockPrice * 1000 * CONFIG.yield);
                this.state.cash += dividend;
                if(dividend > 0) this.showToast(`ğŸ’° é ˜åˆ°è‚¡æ¯ï¼š$${dividend.toLocaleString()}`);
            }

            // 4. ç²¾ç¥å´©æ½°æª¢æŸ¥
            if (this.state.sanity < 30) {
                if (Math.random() > 0.4) {
                    const lost = Math.floor(Math.random() * 5000) + 3000;
                    this.state.cash -= lost;
                    this.state.sanity = 60; 
                    this.showModal("ğŸ’¥ ç²¾ç¥å´©æ½°ï¼", `å·¥ä½œå£“åŠ›å¤ªå¤§äº†ï¼\nä½ ç†æ™ºæ–·ç·šï¼Œè·‘å»åƒäº†é ‚ç´šç‡’è‚‰åˆèª²é‡‘æ‰‹éŠï¼Œå™´äº† $${lost}ã€‚\n(ç²¾ç¥å€¼æ¢å¾©ï¼Œä½†éŒ¢åŒ…å¤§å¤±è¡€)`);
                } else {
                    this.showToast("âš ï¸ ç²¾ç¥å€¼ç€•è‡¨æ¥µé™...");
                }
            }

            // 5. æª¢æŸ¥å‡ç´š/çµå±€
            this.checkProgress(dividend);

            // 6. ç”Ÿæˆäº‹ä»¶
            if (this.state.cash < 0) {
                 this.triggerGameOver();
            } else {
                 this.generateEvent();
            }

            this.updateUI();
        }

        checkProgress(lastDividend) {
            if (this.state.level === 1 && this.state.cash >= 100000) {
                this.state.level = 2;
                this.showModal("ğŸ‰ ç¬¬ä¸€ç« é€šé—œï¼šç”Ÿå­˜çš„ç¸«éš™", 
                    "ä½ å­˜åˆ°äº†ç¬¬ä¸€æ¡¶é‡‘ $100,000ï¼\né€™ç­†éŒ¢æ˜¯ä½ çš„ã€Œç·Šæ€¥é å‚™é‡‘ã€ã€‚\n\nã€ç¬¬äºŒç« ï¼šç¨®å­çš„åŠ›é‡ã€‘\nç¾åœ¨ï¼Œä½ å¯ä»¥é–‹å§‹è²·é€²è‚¡ç¥¨ï¼Œç¨®ä¸‹è³‡ç”¢çš„ç¨®å­ã€‚");
            }
            else if (this.state.level === 2 && this.state.shares >= 10) {
                this.state.level = 3;
                this.showModal("ğŸŒ± ç¬¬äºŒç« é€šé—œï¼šç¨®å­çš„åŠ›é‡", 
                    "ä½ å·²ç¶“æŒæœ‰ 10 å¼µè‚¡ç¥¨ï¼\né›–ç„¶æ¯å­£é…æ¯é‚„ä¸å¤šï¼Œä½†ä½ å·²ç¶“å­¸æœƒé¢å°å¸‚å ´æ³¢å‹•ã€‚\n\nã€ç¬¬ä¸‰ç« ï¼šé›ªçƒçš„æ»¾å‹•ã€‘\nåˆ©ç”¨è¤‡åˆ©æ•ˆæ‡‰ï¼Œè®“è³‡ç”¢åƒé›ªçƒä¸€æ¨£è¶Šæ»¾è¶Šå¤§å§ï¼");
            }
            else if (this.state.level === 3 && lastDividend >= 30000) {
                this.state.level = 4;
                this.showModal("â„ï¸ ç¬¬ä¸‰ç« é€šé—œï¼šé›ªçƒçš„æ»¾å‹•", 
                    "ä½ çš„è‚¡æ¯å·²ç¶“è¶³ä»¥æ”¯ä»˜æˆ¿ç§Ÿï¼\nä½ ä¸å†ç‚ºäº†ç”Ÿå­˜è€Œå·¥ä½œï¼Œè€Œæ˜¯ç‚ºäº†ç”Ÿæ´»ã€‚\n\nã€æœ€çµ‚ç« ï¼šè‡ªç”±çš„æ›™å…‰ã€‘\nå …æŒæœ€å¾Œä¸€å“©è·¯ï¼Œé‚å‘å®Œå…¨çš„è²¡å¯Œè‡ªç”±ã€‚");
            }
            else if (this.state.level === 4) {
                const passiveMonthly = (this.state.shares * this.state.stockPrice * 1000 * CONFIG.yield * 4) / 12;
                if (passiveMonthly > this.state.expense) {
                    this.triggerGoodEnding();
                }
            }
        }

        generateEvent() {
            let pool = LEVEL_EVENTS[this.state.level];
            if(!pool) pool = LEVEL_EVENTS[4]; 
            const eventData = pool[Math.floor(Math.random() * pool.length)];

            document.getElementById('npc-tag').innerText = eventData.npc;
            document.getElementById('story-text').innerText = eventData.text;

            const actionArea = document.getElementById('action-area');
            actionArea.innerHTML = '';

            eventData.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'btn-choice';
                btn.innerHTML = `${choice.text} <span>${choice.sub}</span>`;
                btn.onclick = () => this.resolveEvent(choice);
                actionArea.appendChild(btn);
            });
        }

        resolveEvent(choice) {
            if (choice.action === 'panic_sell') {
                const returnCash = this.state.shares * this.state.stockPrice * 1000;
                this.state.cash += returnCash;
                this.state.shares = 0;
                this.showToast("ğŸ“‰ ä½ æ¸…ç©ºäº†æ‰€æœ‰æŒè‚¡...");
            } else if (choice.action === 'buy_one') {
                const cost = this.state.stockPrice * 1000;
                if(this.state.cash >= cost) {
                    this.state.cash -= cost;
                    this.state.shares++;
                    this.showToast("âœ… åŠ ç¢¼æˆåŠŸï¼");
                } else {
                    this.showToast("âŒ ç¾é‡‘ä¸è¶³ï¼");
                }
            } else if (choice.action === 'study') {
                this.state.knowledge++;
                this.state.sanity += 5;
                this.showToast("ğŸ“– è²¡å•†çŸ¥è­˜æå‡ï¼");
            } else {
                this.state.cash -= (choice.cost || 0);
                this.state.sanity += (choice.sanity || 0);
            }
            this.state.sanity = Math.min(100, Math.max(0, this.state.sanity));
            this.updateUI();
            
            const actionArea = document.getElementById('action-area');
            actionArea.innerHTML = '';
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn-next';
            nextBtn.innerText = "ğŸ“… é€²å…¥ä¸‹å€‹æœˆ";
            nextBtn.onclick = () => this.nextMonth();
            actionArea.appendChild(nextBtn);
        }

        trade(stock, qty) {
            const cost = this.state.stockPrice * 1000;
            if (qty > 0) { 
                if (this.state.cash >= cost) {
                    this.state.cash -= cost;
                    this.state.shares++;
                    this.showToast(`âœ… è²·å…¥ 1 å¼µ (æˆæœ¬ $${cost.toLocaleString()})`);
                } else {
                    this.showToast("âŒ ç¾é‡‘ä¸è¶³");
                }
            } else { 
                if (this.state.shares > 0) {
                    this.state.cash += cost;
                    this.state.shares--;
                    this.showToast(`âœ… è³£å‡º 1 å¼µ (æ”¶å…¥ $${cost.toLocaleString()})`);
                } else {
                    this.showToast("âŒ æ²’æœ‰åº«å­˜");
                }
            }
            this.updateUI();
        }

        triggerGameOver() {
            document.getElementById('modal-icon').innerText = "ğŸ’€";
            this.showModal("BAD END: å¢œè½", 
                "ä½ çš„ç¾é‡‘æµå¾¹åº•æ–·è£‚ã€‚\nç‚ºäº†ç”Ÿå­˜ï¼Œä½ è¢«è¿«å€Ÿäº†é«˜åˆ©è²¸ï¼Œå¾æ­¤é™·å…¥é‚„å‚µçš„æ·±æ·µã€‚\n\nğŸ‘‡ æƒ³çŸ¥é“å¦‚ä½•é¿å…ç ´ç”¢ï¼Ÿå¿«çœ‹æˆ‘çš„æ–‡ç«  ğŸ‘‡");
            
            // é¡¯ç¤ºéƒ¨è½æ ¼é€£çµ
            document.getElementById('modal-blog-btn').style.display = 'block';

            const btn = document.getElementById('modal-action-btn');
            btn.innerText = "é‡æ–°é–‹å§‹";
            btn.onclick = () => location.reload();
        }

        triggerGoodEnding() {
            document.getElementById('modal-icon').innerText = "ğŸ–ï¸";
            this.showModal("GOOD END: ä¸Šç­æ—çš„é€†è¥²", 
                `ä½  45 æ­²äº†ã€‚æ¯å€‹æœˆæµå…¥çš„è‚¡æ¯å·²ç¶“è¶…éäº†è–ªæ°´ã€‚\nä½ éå‡ºè¾­å‘ˆï¼Œä¸æ˜¯å› ç‚ºæ†¤æ€’ï¼Œè€Œæ˜¯å› ç‚ºä½ ã€Œå¯ä»¥ã€ã€‚\n\n(ç¸½è³‡ç”¢ï¼š$${Math.floor(this.state.shares * this.state.stockPrice * 1000 + this.state.cash).toLocaleString()})\n\nğŸ‘‡ æƒ³å­¸ç¿’æ›´å¤šå¯¦æˆ°ç†è²¡ï¼Ÿé—œæ³¨æˆ‘çš„éƒ¨è½æ ¼ ğŸ‘‡`);
            
            // é¡¯ç¤ºéƒ¨è½æ ¼é€£çµ
            document.getElementById('modal-blog-btn').style.display = 'block';
            document.getElementById('modal-action-btn').style.display = 'none'; // çµæŸä¸çµ¦ç¹¼çºŒ
        }

        updateUI() {
            const year = Math.floor(this.state.month / 12) + 1;
            const month = (this.state.month % 12) + 1;
            document.getElementById('game-date').innerText = `ç¬¬ ${year} å¹´ ${month} æœˆ`;
            
            const levelNames = ["ç”Ÿå­˜çš„ç¸«éš™", "ç¨®å­çš„åŠ›é‡", "é›ªçƒçš„æ»¾å‹•", "è‡ªç”±çš„æ›™å…‰"];
            document.getElementById('level-display').innerText = `Ch.${this.state.level}: ${levelNames[this.state.level-1]}`;

            document.getElementById('cash-display').innerText = `$${Math.floor(this.state.cash).toLocaleString()}`;
            
            const assetVal = this.state.shares * this.state.stockPrice * 1000;
            document.getElementById('asset-display').innerText = `$${Math.floor(assetVal).toLocaleString()}`;
            
            const bar = document.getElementById('sanity-bar');
            bar.style.width = `${this.state.sanity}%`;
            document.getElementById('sanity-text').innerText = `${this.state.sanity}/100`;
            if(this.state.sanity < 30) bar.style.background = '#e74c3c';
            else if(this.state.sanity < 60) bar.style.background = '#f1c40f';
            else bar.style.background = '#2ecc71';

            const flow = CONFIG.salary - this.state.expense;
            document.getElementById('flow-display').innerText = `${flow > 0 ? '+' : ''}$${Math.floor(flow).toLocaleString()}`;

            document.getElementById('price-878').innerText = `$${this.state.stockPrice.toFixed(2)}`;
            document.getElementById('cost-878').innerText = Math.floor(this.state.stockPrice * 1000).toLocaleString();
            document.getElementById('qty-878').innerText = this.state.shares;

            const bg = document.getElementById('main-bg');
            bg.className = `main-stage bg-level${this.state.level}`;

            document.getElementById('invest-panel').style.display = this.state.level >= 2 ? 'block' : 'none';
        }

        showModal(title, desc) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            document.getElementById('modal').style.display = 'flex';
        }

        showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
    }

    const game = new Game();
</script>
</body>
</html>
