<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾é‡‘æµå¤§å¯Œç¿ - å®Œæ•´ä¿®è¨‚ç‰ˆ</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* åŸºç¤è¨­å®šèˆ‡é˜²å‘† */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; touch-action: manipulation; }
        .board-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 2px;
            aspect-ratio: 1/1;
        }
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .pop-up { animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* éš±è—å·è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden no-select">

    <div id="root"></div>

    <div id="error-display" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; padding:20px; color:red;">
        <h2 class="text-2xl font-bold">ç™¼ç”ŸéŒ¯èª¤</h2>
        <p>è«‹é‡æ–°æ•´ç†é é¢ã€‚</p>
        <pre id="error-log" class="text-sm mt-4 bg-gray-800 p-2 rounded"></pre>
        <button onclick="localStorage.clear(); window.location.reload();" class="mt-4 px-4 py-2 bg-white text-black rounded">æ¸…é™¤å­˜æª”ä¸¦é‡æ•´</button>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-log').innerText = `${msg}\nLine: ${line}`;
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useReducer, useMemo, useEffect } = React;

        // --- 1. éŠæˆ²è³‡æ–™è¨­å®š ---
        const BOARD_SIZE = 20;
        const BLOG_URL = "https://vocus.cc/user/@WUCJ"; // ä½ çš„å°ˆæ¬„é€£çµ

        const PLAYERS_DB = [
            { bg: 'bg-red-500', name: 'ç©å®¶ 1' }, { bg: 'bg-blue-500', name: 'ç©å®¶ 2' },
            { bg: 'bg-green-500', name: 'ç©å®¶ 3' }, { bg: 'bg-purple-500', name: 'ç©å®¶ 4' }
        ];

        const OCCUPATIONS = [
            { title: 'é†«å¸«', salary: 12000, savings: 3000, liab: [{name:'å­¸è²¸', val:120000, exp:1000}] },
            { title: 'å·¥ç¨‹å¸«', salary: 8000, savings: 4000, liab: [{name:'æˆ¿è²¸', val:80000, exp:800}] },
            { title: 'æ•™å¸«', salary: 4000, savings: 2000, liab: [{name:'ä¿¡è²¸', val:10000, exp:150}] },
            { title: 'å¸æ©Ÿ', salary: 3500, savings: 1500, liab: [{name:'è»Šè²¸', val:5000, exp:100}] },
            // åŠ å…¥ä½ çš„å°ˆå±¬è·æ¥­
            { title: 'å€‰å„²ç‰©æµå¸«', salary: 42000, savings: 4000, liab: [{name:'æˆ¿è²¸', val:46000, exp:2000}] } 
        ];

        const MAP_TILES = [
            { type: 'START', label: 'èµ·é»', color: 'bg-yellow-600' },
            { type: 'DEAL_S', label: 'å°ç”Ÿæ„', color: 'bg-green-600' }, { type: 'DEAL_S', label: 'å°ç”Ÿæ„', color: 'bg-green-600' },
            { type: 'DOODAD', label: 'æ”¯å‡º', color: 'bg-red-500' }, { type: 'DEAL_B', label: 'å¤§è²·è³£', color: 'bg-emerald-700' },
            { type: 'MARKET', label: 'å¸‚å ´', color: 'bg-blue-600' },
            { type: 'DEAL_S', label: 'å°ç”Ÿæ„', color: 'bg-green-600' }, { type: 'CHARITY', label: 'å‘½é‹', color: 'bg-gray-600' },
            { type: 'DEAL_B', label: 'å¤§è²·è³£', color: 'bg-emerald-700' }, { type: 'DOODAD', label: 'æ”¯å‡º', color: 'bg-red-500' },
            { type: 'MARKET', label: 'å¸‚å ´', color: 'bg-blue-600' },
            { type: 'DEAL_S', label: 'å°ç”Ÿæ„', color: 'bg-green-600' }, { type: 'DEAL_S', label: 'å°ç”Ÿæ„', color: 'bg-green-600' },
            { type: 'CHARITY', label: 'å‘½é‹', color: 'bg-gray-600' }, { type: 'DEAL_B', label: 'å¤§è²·è³£', color: 'bg-emerald-700' },
            { type: 'DOODAD', label: 'æ”¯å‡º', color: 'bg-red-500' },
            { type: 'DEAL_S', label: 'å°ç”Ÿæ„', color: 'bg-green-600' }, { type: 'MARKET', label: 'å¸‚å ´', color: 'bg-blue-600' },
            { type: 'DEAL_B', label: 'å¤§è²·è³£', color: 'bg-emerald-700' }, { type: 'CHARITY', label: 'å‘½é‹', color: 'bg-gray-600' },
        ];

        const ASSETS_DB = {
            SMALL: [
                { name: 'ç§‘æŠ€è‚¡', cost: 1000, down: 1000, cashflow: 0, type: 'è‚¡ç¥¨' },
                { name: 'é«˜æ¯ ETF', cost: 5000, down: 5000, cashflow: 50, type: 'è‚¡ç¥¨' },
                { name: 'é«˜é›„èˆŠå…¬å¯“', cost: 50000, down: 5000, cashflow: 200, type: 'æˆ¿ç”¢' },
                { name: 'æ³•æ‹å±‹', cost: 30000, down: 2000, cashflow: 300, type: 'æˆ¿ç”¢' },
            ],
            BIG: [
                { name: 'å¸‚å€è±ªå®…', cost: 150000, down: 30000, cashflow: 1000, type: 'æˆ¿ç”¢' },
                { name: 'è‡ªå‹•æ´—è¡£åº—', cost: 100000, down: 20000, cashflow: 1500, type: 'ä¼æ¥­' },
                { name: '10æˆ¶å…¬å¯“', cost: 300000, down: 50000, cashflow: 2500, type: 'æˆ¿ç”¢' },
            ]
        };

        const MARKET_CARDS = [
            { text: 'æˆ¿å¸‚ç†±ï¼æˆ¿ç”¢è³£åƒ¹ 2 å€', target: 'æˆ¿ç”¢', multi: 2 },
            { text: 'ä¼æ¥­ä½µè³¼ï¼ä¼æ¥­è³£åƒ¹ 2 å€', target: 'ä¼æ¥­', multi: 2 },
            { text: 'å¸‚å ´å¹³æ·¡', target: 'NONE' },
            { text: 'æ€¥è³¼ å…¬å¯“ $60,000', target: 'é«˜é›„èˆŠå…¬å¯“', price: 60000 },
        ];

        // --- 2. é‚è¼¯æ ¸å¿ƒ (Reducer) ---
        const INITIAL_STATE = { status: 'SETUP', players: [], turnIndex: 0, logs: [], winner: null };

        function gameReducer(state, action) {
            let newState = JSON.parse(JSON.stringify(state));
            
            switch (action.type) {
                case 'RESET': return INITIAL_STATE;
                
                case 'SETUP_GAME':
                    return {
                        ...INITIAL_STATE,
                        status: 'PLAYING',
                        players: Array.from({ length: action.count }, (_, i) => {
                            const job = OCCUPATIONS[Math.floor(Math.random() * OCCUPATIONS.length)];
                            return {
                                id: i,
                                name: PLAYERS_DB[i].name,
                                job: job.title,
                                cash: job.savings,
                                salary: job.salary,
                                expenses: Math.floor(job.salary * 0.6),
                                position: 0,
                                assets: [],
                                // ä¿®æ­£ï¼šç¢ºä¿æ¯å€‹è² å‚µéƒ½æœ‰å”¯ä¸€ IDï¼Œé‚„æ¬¾æ‰ä¸æœƒå‡ºéŒ¯
                                liabilities: job.liab.map((l, idx) => ({...l, id: `L_INIT_${i}_${idx}`})),
                                isFree: false
                            };
                        }),
                        logs: ['éŠæˆ²é–‹å§‹ï¼']
                    };

                case 'MOVE_TOKEN': {
                    const p = newState.players[newState.turnIndex];
                    const newPos = (p.position + action.steps) % BOARD_SIZE;
                    if (newPos < p.position && action.steps > 0) {
                        // é ˜è–ªæ°´æ—¥ï¼šæ”¶å…¥ - æ”¯å‡º
                        const passive = p.assets.reduce((s,a)=>s+a.cashflow,0);
                        const liabExp = p.liabilities.reduce((s,l)=>s+l.exp,0);
                        const flow = p.salary + passive - p.expenses - liabExp;
                        p.cash += flow;
                        newState.logs.unshift(`${p.name} é ˜è–ªæ°´ $${flow}`);
                    }
                    p.position = newPos;
                    return newState;
                }

                case 'TRANSACTION': {
                    const p = newState.players[newState.turnIndex];
                    const { kind, data } = action;
                    const uid = Math.random().toString(36).substr(2, 9); // ç”Ÿæˆéš¨æ©ŸID

                    if (kind === 'BUY') {
                        p.cash -= data.down;
                        p.assets.push({ ...data, uid: `A_${uid}` });
                        newState.logs.unshift(`${p.name} è²·å…¥ ${data.name}`);
                    } else if (kind === 'LOAN') {
                        const amt = data.amount;
                        p.cash += amt;
                        p.liabilities.push({ 
                            name: 'éŠ€è¡Œä¿¡è²¸', 
                            val: amt, 
                            exp: Math.ceil(amt*0.1), // åˆ©æ¯ 10%
                            id: `L_${uid}` 
                        });
                        newState.logs.unshift(`${p.name} è²¸æ¬¾ $${amt}`);
                    } else if (kind === 'PAY') { 
                        p.cash -= data.amount;
                        newState.logs.unshift(`${p.name} æ”¯ä»˜ $${data.amount}`);
                    } else if (kind === 'SELL') {
                        p.cash += data.price;
                        p.assets = p.assets.filter(a => a.uid !== data.assetUid);
                        newState.logs.unshift(`${p.name} è³£å‡ºç²åˆ© $${data.price}`);
                    } else if (kind === 'REPAY') { // æ–°å¢ï¼šé‚„å‚µé‚è¼¯
                        p.cash -= data.val;
                        p.liabilities = p.liabilities.filter(l => l.id !== data.id);
                        newState.logs.unshift(`${p.name} é‚„æ¸… ${data.name}`);
                    }
                    return newState;
                }

                case 'NEXT_TURN':
                    newState.turnIndex = (newState.turnIndex + 1) % newState.players.length;
                    return newState;

                case 'WIN':
                    newState.status = 'WIN';
                    newState.winner = action.player;
                    return newState;

                default: return state;
            }
        }

        // --- 3. React çµ„ä»¶ ---
        function App() {
            const [state, dispatch] = useReducer(gameReducer, INITIAL_STATE);
            
            // ä»‹é¢ç‹€æ…‹
            const [dice, setDice] = useState(0);
            const [rolling, setRolling] = useState(false);
            const [modal, setModal] = useState(null); 
            const [phase, setPhase] = useState('READY'); // READY, MOVING, DONE
            const [count, setCount] = useState(2);
            const [view, setView] = useState('BOARD');

            const curP = state.players[state.turnIndex];

            // å³æ™‚è²¡å‹™è¨ˆç®— (useMemo å„ªåŒ–æ•ˆèƒ½)
            const fin = useMemo(() => {
                if (!curP) return { passive:0, totalExp:0, flow:0, progress:0 };
                const passive = curP.assets.reduce((s,a)=>s+a.cashflow,0);
                const liabExp = curP.liabilities.reduce((s,l)=>s+l.exp,0);
                const totalExp = curP.expenses + liabExp;
                const flow = curP.salary + passive - totalExp;
                const progress = totalExp > 0 ? Math.min(Math.round(passive/totalExp*100), 100) : 0;
                return { passive, totalExp, flow, progress };
            }, [curP, curP ? curP.assets : null, curP ? curP.liabilities : null]);

            // å‹åˆ©æ¢ä»¶ç›£è½
            useEffect(() => {
                if (curP && fin.passive > fin.totalExp && !curP.isFree && curP.assets.length > 0) {
                    dispatch({ type: 'WIN', player: curP });
                }
            }, [fin, curP]);

            const roll = () => {
                setRolling(true);
                setTimeout(() => {
                    const r = Math.floor(Math.random()*6)+1;
                    setDice(r);
                    setRolling(false);
                    dispatch({ type: 'MOVE_TOKEN', steps: r });
                    
                    setTimeout(() => {
                        const pos = (curP.position + r) % BOARD_SIZE;
                        const tile = MAP_TILES[pos];
                        
                        // æ ¹æ“šæ ¼å­è§¸ç™¼äº‹ä»¶
                        if (tile.type.includes('DEAL')) {
                            const pool = tile.type === 'DEAL_B' ? ASSETS_DB.BIG : ASSETS_DB.SMALL;
                            const d = pool[Math.floor(Math.random()*pool.length)];
                            setModal({ type: 'DEAL', data: d });
                        } else if (tile.type === 'DOODAD') {
                            const amt = Math.floor(Math.random()*500)+100;
                            setModal({ type: 'MSG', text: 'è³¼è²·å¥¢ä¾ˆå“', amt: -amt, act: 'PAY' });
                        } else if (tile.type === 'MARKET') {
                            const m = MARKET_CARDS[Math.floor(Math.random()*MARKET_CARDS.length)];
                            let sellable = [];
                            if (m.target !== 'NONE') {
                                sellable = curP.assets.filter(a => m.target === 'æˆ¿ç”¢' || m.target === 'ä¼æ¥­' ? a.type === m.target : a.name === m.target);
                            }
                            setModal({ type: 'MARKET', data: m, sellable });
                        } else {
                            setPhase('DONE');
                        }
                    }, 500);
                }, 500);
            };

            const endTurn = () => {
                setDice(0);
                setPhase('READY');
                dispatch({ type: 'NEXT_TURN' });
            };

            const handleBuy = (asset, withLoan = false) => {
                if (withLoan) {
                    const gap = asset.down - curP.cash;
                    const loan = Math.ceil(gap/1000)*1000;
                    dispatch({ type: 'TRANSACTION', kind: 'LOAN', data: { amount: loan } });
                }
                dispatch({ type: 'TRANSACTION', kind: 'BUY', data: asset });
                setModal(null);
                setPhase('DONE');
            };

            const renderTile = (i) => {
                const t = MAP_TILES[i];
                const here = state.players.filter(p => p.position === i);
                // Grid Logic: 6x6 Hollow Box
                let area = '';
                if(i<6) area = `1 / ${i+1} / 2 / ${i+2}`;
                else if(i<10) area = `${i-4} / 6 / ${i-3} / 7`;
                else if(i<16) area = `6 / ${16-i} / 7 / ${17-i}`;
                else area = `${21-i} / 1 / ${22-i} / 2`;

                return (
                    <div key={i} style={{gridArea: area}} className={`relative border border-white/10 rounded flex flex-col items-center justify-center p-1 text-[10px] shadow-inner ${t.color}`}>
                        {t.type==='START'&&<div className="absolute inset-0 border-2 border-yellow-400 animate-pulse rounded"></div>}
                        <span className="font-bold z-0">{t.label}</span>
                        <div className="flex flex-wrap justify-center gap-1 z-10 mt-1">
                            {here.map(p => <div key={p.id} className={`w-3 h-3 rounded-full border border-white shadow ${PLAYERS_DB[p.id].bg}`}></div>)}
                        </div>
                    </div>
                );
            };

            // --- Views: éŠæˆ²å‰è¨­å®š ---
            if (state.status === 'SETUP') {
                return (
                    <div className="h-[100dvh] bg-gray-900 flex items-center justify-center p-4">
                        <div className="bg-gray-800 p-8 rounded-2xl max-w-sm w-full text-center border border-gray-700">
                            <h1 className="text-3xl font-bold text-yellow-400 mb-6">ç¾é‡‘æµå¤§å¯Œç¿</h1>
                            <div className="mb-6">
                                <p className="mb-2 text-gray-300">é¸æ“‡éŠç©äººæ•¸</p>
                                <div className="flex justify-center gap-2">
                                    {[1,2,3,4].map(n => (
                                        <button key={n} onClick={()=>setCount(n)} className={`w-10 h-10 rounded-lg font-bold ${count===n?'bg-yellow-500 text-black':'bg-gray-700'}`}>{n}</button>
                                    ))}
                                </div>
                            </div>
                            <button onClick={()=>dispatch({type:'SETUP_GAME', count})} className="w-full py-3 bg-blue-600 rounded-xl font-bold text-lg hover:bg-blue-500">é–‹å§‹éŠæˆ²</button>
                        </div>
                    </div>
                );
            }

            // --- Views: å‹åˆ©ç•«é¢ ---
            if (state.status === 'WIN') {
                return (
                    <div className="h-[100dvh] bg-gray-900 flex items-center justify-center p-4">
                        <div className="bg-white text-gray-900 p-8 rounded-3xl text-center max-w-sm w-full">
                            <div className="text-6xl mb-4">ğŸ†</div>
                            <h2 className="text-2xl font-bold mb-2 text-yellow-600">{state.winner.name} è²¡å¯Œè‡ªç”±ï¼</h2>
                            <p className="text-gray-500 mb-6 text-sm">æ­å–œè·³å‡ºè€é¼ è³½è·‘åœˆ</p>
                            <div className="bg-gray-100 p-4 rounded mb-4 text-left text-sm">
                                <p>è·æ¥­ï¼š{state.winner.job}</p>
                                <p>è¢«å‹•æ”¶å…¥ï¼š${fin.passive}</p>
                                <p>ç¸½æ”¯å‡ºï¼š${fin.totalExp}</p>
                            </div>
                            <a href={BLOG_URL} target="_blank" className="block w-full py-3 bg-gray-900 text-white rounded-xl font-bold mb-4 text-sm">ğŸ“– å­¸ç¿’è‡´å¯Œå¿ƒæ³•</a>
                            <button onClick={()=>window.location.reload()} className="text-gray-400 underline text-sm">é‡æ–°é–‹å§‹</button>
                        </div>
                    </div>
                );
            }

            // --- Views: ä¸»è¦éŠæˆ²ç•«é¢ ---
            return (
                <div className="flex flex-col md:flex-row h-[100dvh] bg-gray-900 overflow-hidden">
                    <button onClick={()=>window.location.reload()} className="absolute top-2 left-2 z-50 text-[10px] text-gray-600 hover:text-gray-400 border border-gray-700 px-1 rounded">é‡ç½®</button>

                    {/* æ‰‹æ©Ÿç‰ˆå°èˆªåˆ— */}
                    <div className="md:hidden bg-gray-800 p-2 flex justify-between items-center z-20 shadow border-b border-gray-700">
                        <div className="flex items-center gap-2">
                            <div className={`w-3 h-3 rounded-full ${PLAYERS_DB[curP.id].bg}`}></div>
                            <span className="font-bold text-sm">{curP.name} ({curP.job})</span>
                        </div>
                        <div className="flex bg-gray-900 rounded p-1">
                            <button onClick={()=>setView('BOARD')} className={`px-3 py-1 text-xs rounded ${view==='BOARD'?'bg-gray-700':''}`}>åœ°åœ–</button>
                            <button onClick={()=>setView('STATS')} className={`px-3 py-1 text-xs rounded ${view==='STATS'?'bg-gray-700':''}`}>å ±è¡¨</button>
                        </div>
                    </div>

                    {/* å·¦å´: åœ°åœ–å€ */}
                    <div className={`flex-1 p-2 md:p-6 flex flex-col items-center justify-center relative ${view==='BOARD'?'flex':'hidden md:flex'}`}>
                        {/* é›»è…¦ç‰ˆä¸Šæ–¹è³‡è¨Š */}
                        <div className="hidden md:flex absolute top-4 w-full px-8 justify-between">
                            <h1 className="font-bold text-yellow-400">ç¾é‡‘æµå¤§å¯Œç¿</h1>
                            <div className="flex gap-2">
                                {state.players.map(p => <div key={p.id} className={`w-4 h-4 rounded-full ${PLAYERS_DB[p.id].bg} ${state.turnIndex===p.id?'ring-2 ring-white':''}`}></div>)}
                            </div>
                        </div>

                        <div className="board-grid w-full max-w-[500px] h-auto bg-gray-800 p-1 rounded-xl shadow-2xl relative">
                            {Array.from({length:20}).map((_, i) => renderTile(i))}
                            
                            {/* ä¸­å¤®æ§åˆ¶å€ */}
                            <div className="col-start-2 col-end-6 row-start-2 row-end-6 bg-gray-900 m-1 rounded-lg border border-gray-700 flex flex-col items-center justify-center p-4 z-10">
                                <div className="text-gray-500 text-xs mb-1">Current Turn</div>
                                <div className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span className={`w-3 h-3 rounded-full ${PLAYERS_DB[curP.id].bg}`}></span>
                                    {curP.name}
                                </div>
                                <div className="w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-4xl mb-4 border border-gray-600">
                                    {rolling ? <span className="animate-spin text-2xl">âš™ï¸</span> : (dice || 'ğŸ²')}
                                </div>
                                {phase === 'READY' && <button onClick={roll} disabled={rolling} className={`w-32 py-2 rounded-lg font-bold shadow-lg ${PLAYERS_DB[curP.id].bg}`}>æ“²éª°å­</button>}
                                {phase === 'DONE' && <button onClick={endTurn} className="w-32 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold border border-gray-500 animate-pulse">çµæŸå›åˆ</button>}
                                {(phase === 'MOVING' || rolling) && <div className="text-xs text-gray-500 animate-pulse">...</div>}
                            </div>
                        </div>
                    </div>

                    {/* å³å´: è²¡å‹™å ±è¡¨å€ (å·²ä¿®å¾©é‚„å‚µåŠŸèƒ½) */}
                    <div className={`w-full md:w-80 bg-gray-800 border-l border-gray-700 flex flex-col ${view==='STATS'?'block h-full':'hidden md:flex'}`}>
                        {/* ä¸Šæ–¹ç¾é‡‘èˆ‡é€²åº¦æ¢ */}
                        <div className="p-4 border-b border-gray-700 bg-black/20">
                            <div className="flex justify-between items-end mb-2">
                                <div>
                                    <div className="text-xs text-gray-400">ç¾é‡‘ (Cash)</div>
                                    <div className="text-2xl font-mono font-bold text-white">${curP.cash.toLocaleString()}</div>
                                </div>
                                <button onClick={()=>{
                                    dispatch({type:'TRANSACTION', kind:'LOAN', data:{amount:1000}});
                                    setModal(null);
                                }} className="text-[10px] bg-red-900 text-red-100 px-2 py-1 rounded border border-red-500 hover:bg-red-800">+è²¸$1000</button>
                            </div>
                            <div className="w-full bg-gray-700 h-1.5 rounded-full mt-2 overflow-hidden">
                                <div className="bg-green-500 h-full transition-all duration-500" style={{width: `${fin.progress}%`}}></div>
                            </div>
                            <div className="text-[10px] text-right mt-1 text-green-400">è‡ªç”±åº¦: {fin.progress}%</div>
                        </div>

                        {/* åˆ—è¡¨å€ */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                            {/* æç›Šè¡¨ */}
                            <div className="bg-gray-700/30 p-3 rounded border border-gray-600 text-sm">
                                <div className="flex justify-between text-xs text-gray-400 mb-1"><span>æç›Šè¡¨</span></div>
                                <div className="flex justify-between"><span>è–ªè³‡</span><span>+${curP.salary}</span></div>
                                <div className="flex justify-between text-green-400"><span>è¢«å‹•</span><span>+${fin.passive}</span></div>
                                <div className="flex justify-between text-red-400"><span>æ”¯å‡º</span><span>-${fin.totalExp}</span></div>
                                <div className="border-t border-gray-600 mt-1 pt-1 flex justify-between font-bold"><span>æœˆç¾é‡‘æµ</span><span>${fin.flow}</span></div>
                            </div>
                            
                            {/* è³‡ç”¢å€ */}
                            <div>
                                <div className="text-xs text-gray-500 mb-1">è³‡ç”¢ ({curP.assets.length})</div>
                                <div className="space-y-1">
                                    {curP.assets.map((a,i)=>(
                                        <div key={i} className="flex justify-between text-xs bg-gray-700/50 p-2 rounded border-l-2 border-green-500">
                                            <span>{a.name}</span><span className="text-green-400">+{a.cashflow}</span>
                                        </div>
                                    ))}
                                    {curP.assets.length===0 && <div className="text-xs text-gray-600 text-center">ç„¡è³‡ç”¢</div>}
                                </div>
                            </div>

                            {/* è² å‚µå€ (æ–°å¢é‚„æ¬¾æŒ‰éˆ•) */}
                            <div>
                                <div className="text-xs text-gray-500 mb-1 flex justify-between">
                                    <span>è² å‚µ (é»æ“Šé‚„æ¬¾)</span>
                                    <span>æœˆæ”¯å‡º</span>
                                </div>
                                <div className="space-y-1">
                                    {curP.liabilities.map((l)=>(
                                        <button 
                                            key={l.id} 
                                            disabled={curP.cash < l.val}
                                            onClick={() => {
                                                if(confirm(`ç¢ºèªè¦é‚„æ¸… ${l.name} ($${l.val}) å—ï¼Ÿ\næ¯æœˆæ”¯å‡ºå°‡æ¸›å°‘ $${l.exp}`)) {
                                                    dispatch({type:'TRANSACTION', kind:'REPAY', data: l});
                                                }
                                            }}
                                            className={`w-full flex justify-between text-xs p-2 rounded border-l-2 border-red-500 transition-colors ${curP.cash >= l.val ? 'bg-red-900/30 hover:bg-red-900/50 cursor-pointer' : 'bg-gray-700/30 opacity-50 cursor-not-allowed'}`}
                                        >
                                            <div className="text-left">
                                                <div>{l.name}</div>
                                                <div className="text-[9px] opacity-70">æ¬ æ¬¾: ${l.val}</div>
                                            </div>
                                            <span className="text-red-400">-${l.exp}</span>
                                        </button>
                                    ))}
                                    {curP.liabilities.length===0 && <div className="text-xs text-green-600 text-center">ç„¡è² å‚µï¼å¤ªæ£’äº†</div>}
                                </div>
                            </div>
                            
                            {/* éŠæˆ²ç´€éŒ„ */}
                            <div className="bg-black/20 p-2 rounded h-32 overflow-y-auto text-[10px] text-gray-400 font-mono">
                                {state.logs.map((l,i)=><div key={i} className="mb-1">{l}</div>)}
                            </div>
                        </div>
                    </div>

                    {/* å½ˆå‡ºè¦–çª— (Modal) */}
                    {modal && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                            <div className="bg-gray-800 w-full max-w-sm rounded-xl border border-gray-600 shadow-2xl overflow-hidden pop-up">
                                <div className={`p-3 text-center font-bold ${modal.type==='DEAL'?'bg-green-700':modal.type==='MSG'?'bg-red-800':'bg-blue-700'}`}>
                                    {modal.type==='DEAL'?'æŠ•è³‡æ©Ÿæœƒ':modal.type==='MSG'?'æ”¯å‡º':modal.type==='MARKET'?'å¸‚å ´é¢¨é›²':'è¨Šæ¯'}
                                </div>
                                <div className="p-5 text-sm">
                                    {modal.type === 'DEAL' && (
                                        <>
                                            <div className="text-center mb-4">
                                                <h4 className="text-lg font-bold text-yellow-400">{modal.data.name}</h4>
                                                <p className="text-gray-400 text-xs">{modal.data.type}</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-4 text-center">
                                                <div className="bg-gray-700 p-2 rounded"><div className="text-[10px] text-gray-400">é ­æœŸæ¬¾</div><div className="font-bold">${modal.data.down}</div></div>
                                                <div className="bg-gray-700 p-2 rounded"><div className="text-[10px] text-gray-400">ç¾é‡‘æµ</div><div className="text-green-400 font-bold">+${modal.data.cashflow}</div></div>
                                                <div className="bg-gray-700 p-2 rounded"><div className="text-[10px] text-gray-400">ç¸½åƒ¹</div><div className="text-gray-300">${modal.data.cost}</div></div>
                                                <div className="bg-gray-700 p-2 rounded"><div className="text-[10px] text-gray-400">ROI</div><div className="text-blue-300">{modal.data.cashflow>0?Math.round(modal.data.cashflow*12/modal.data.down*100):0}%</div></div>
                                            </div>
                                            {curP.cash >= modal.data.down ? (
                                                <button onClick={()=>handleBuy(modal.data)} className="w-full py-2 bg-green-600 rounded-lg font-bold mb-2 hover:bg-green-500">è³¼è²·</button>
                                            ) : (
                                                <button onClick={()=>handleBuy(modal.data, true)} className="w-full py-2 bg-yellow-600 rounded-lg font-bold mb-2 hover:bg-yellow-500">
                                                    è³‡é‡‘ä¸è¶³ï¼Ÿ è²¸æ¬¾ä¸¦è³¼è²·<br/><span className="text-[10px] opacity-80">(è‡ªå‹•å€Ÿ ${Math.ceil((modal.data.down-curP.cash)/1000)*1000})</span>
                                                </button>
                                            )}
                                            <button onClick={()=>setModal(null)||setPhase('DONE')} className="w-full py-2 bg-gray-600 rounded-lg font-bold">æ”¾æ£„</button>
                                        </>
                                    )}
                                    {modal.type === 'MSG' && (
                                        <div className="text-center">
                                            <p className="mb-2">{modal.text}</p>
                                            <p className="text-2xl font-bold text-red-500 mb-4">{modal.amt}</p>
                                            <button onClick={()=>{ dispatch({type:'TRANSACTION', kind:modal.act, data:{amount:Math.abs(modal.amt)}}); setModal(null); setPhase('DONE'); }} className="w-full py-2 bg-red-600 rounded-lg font-bold">æ”¯ä»˜</button>
                                        </div>
                                    )}
                                    {modal.type === 'MARKET' && (
                                        <div className="text-center">
                                            <p className="font-bold mb-4">{modal.data.text}</p>
                                            {modal.sellable && modal.sellable.length > 0 ? (
                                                <div className="space-y-2 mb-4">
                                                    {modal.sellable.map(a => (
                                                        <button key={a.uid} onClick={()=>{
                                                            const p = modal.data.price || (a.down * modal.data.multi);
                                                            dispatch({type:'TRANSACTION', kind:'SELL', data:{assetUid:a.uid, price:p}});
                                                            setModal(null); setPhase('DONE');
                                                        }} className="w-full py-2 bg-green-700 rounded flex justify-between px-3">
                                                            <span>è³£å‡º {a.name}</span><span className="font-bold">+${modal.data.price||(a.down*modal.data.multi)}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            ) : <p className="text-gray-500 italic mb-4">ç„¡å¯äº¤æ˜“è³‡ç”¢</p>}
                                            <button onClick={()=>setModal(null)||setPhase('DONE')} className="w-full py-2 bg-gray-600 rounded-lg font-bold">é›¢é–‹</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
